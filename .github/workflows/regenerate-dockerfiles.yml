# Copyright 2025 Miget (https://miget.com)
# Licensed under the Apache License, Version 2.0

name: Regenerate Dockerfiles

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *"

jobs:
  regenerate:
    name: Refresh Dockerfiles and Create Release PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Fetch latest docker-compose version
        run: python scripts/update_docker_compose_version.py
      
      - name: Fetch latest package versions
        run: python scripts/update_manifest_versions.py
      
      - name: Record Ubuntu base digests
        run: |
          python scripts/check_ubuntu_digest.py 22.04 --record || true
          python scripts/check_ubuntu_digest.py 24.04 --record || true
      
      - name: Check for significant changes
        id: check_changes
        run: |
          if python scripts/detect_changes.py; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Significant changes detected - will bump version"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No significant changes - skipping version bump"
          fi
        continue-on-error: true
      
      - name: Bump version if changes detected
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "Bumping patch version due to component updates"
          python scripts/bump_version.py
      
      - name: Render Dockerfiles
        run: python scripts/render_dockerfiles.py
      
      - name: Update README component versions table
        run: python scripts/update_readme_table.py
      
      - name: Update README tag table
        run: python scripts/update_readme_tags.py
      
      - name: Generate changelog entry
        run: python scripts/update_changelog.py --auto
      
      - name: Get new version
        id: version
        run: |
          VERSION=$(python -c "import json; print(json.load(open('manifests/targets.json'))['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "New version: $VERSION"
      
      - name: Configure git
        run: |
          git config user.name "miget-bot"
          git config user.email "bot@miget.dev"
      
      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: release v${{ steps.version.outputs.version }}"
          branch: release/v${{ steps.version.outputs.version }}
          title: "Release v${{ steps.version.outputs.version }}"
          body: |
            ## Release v${{ steps.version.outputs.version }}
            
            Automated release with updated components:
            - Docker Compose, Docker CE, Podman, or base OS versions updated
            - Dockerfiles regenerated from templates
            - README and changelog updated
            
            ### Changes
            - Updated package versions in manifests
            - Regenerated all Dockerfiles
            - Updated component versions table in README
            - Updated changelog
            
            **This PR will trigger image builds and publishing on merge.**
          labels: |
            release
            automated

